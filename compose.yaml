services:
  # Landing Page
  landing-page:
    build:
      context: ./src/landing-page
      dockerfile: Dockerfile
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.landing-page.rule=Host(`${DOMAIN}`)"
      - "traefik.http.routers.landing-page.entrypoints=web"
      - "traefik.http.services.landing-page.loadbalancer.server.port=80"

  # Example Web UI Vanilla
  example-web-ui-vanilla:
    build:
      context: ./src/example-web-ui-vanilla
      dockerfile: Dockerfile
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.ui-vanilla.rule=Host(`ui-vanilla.${DOMAIN}`)"
      - "traefik.http.routers.ui-vanilla.entrypoints=web"
      - "traefik.http.services.ui-vanilla.loadbalancer.server.port=80"

  # Example Web UI NextJS
  example-web-ui-nextjs:
    build:
      context: ./src/example-web-ui-nextjs
      dockerfile: Dockerfile
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.ui-nextjs.rule=Host(`ui-nextjs.${DOMAIN}`)"
      - "traefik.http.routers.ui-nextjs.entrypoints=web"
      - "traefik.http.services.ui-nextjs.loadbalancer.server.port=80"

  # Example Web API Service
  example-web-api-service:
    build:
      context: ./src/example-web-api-service
      dockerfile: Dockerfile
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.api-dotnet.rule=Host(`api-dotnet.${DOMAIN}`)"
      - "traefik.http.routers.api-dotnet.entrypoints=web"
      - "traefik.http.services.api-dotnet.loadbalancer.server.port=80"

  # Example Web API with Database - Database Initialization
  # ------------------------------------------------------
  # Phase 1 (Init): Creates the commentary database and service user
  # Following Zitadel's three-phase pattern, skipping Phase 2 (setup)
  # Phase 3 (start): The service runs migrations automatically on startup
  commentary-service-init:
    build:
      context: ./src/example-web-api-with-database
      dockerfile: Dockerfile
      target: init-runtime
    restart: no
    environment:
      # Database connection settings
      POSTGRES_HOST: database
      POSTGRES_PORT: 5432
      # Database admin credentials
      POSTGRES_ADMIN_USER: postgres
      POSTGRES_ADMIN_PASSWORD: postgres
      # Commentary database configuration
      COMMENTARY_DATABASE: commentary
      COMMENTARY_USER: commentary
      COMMENTARY_PASSWORD: commentary
    depends_on:
      database:
        condition: service_healthy

  # Example Web API with Database
  commentary-service:
    build:
      context: ./src/example-web-api-with-database
      dockerfile: Dockerfile
      target: api-runtime
    environment:
      POSTGRES_HOST: database
      POSTGRES_PORT: 5432
      POSTGRES_DATABASE: commentary
      POSTGRES_USER: commentary
      POSTGRES_PASSWORD: commentary
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.commentary.rule=Host(`commentary.${DOMAIN}`)"
      - "traefik.http.routers.commentary.entrypoints=web"
      - "traefik.http.services.commentary.loadbalancer.server.port=80"
    depends_on:
      commentary-service-init:
        condition: service_completed_successfully
